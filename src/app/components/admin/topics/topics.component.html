<app-navbar></app-navbar>
<div
  class="container-fluid px-5"
  style="background-color: #e9f3f9; min-height: 88vh"
>
  <div class="row mb-3 align-items-center">
    <div class="col">
      <label class="mt-3">Topics</label>
    </div>
    <div class="col" style="display: flex; justify-content: flex-end">
      <button
        style="
          border: none;
          background-color: #ffffff;
          box-shadow: black;
          border-radius: 5px;
          width: 35px;
        "
        class="mt-3"
        (click)="resetTable()"
      >
        <i
          class="fa-solid fa-rotate-right mt-2 mb-2"
          style="color: #2f72f4; font: 20px"
        ></i>
      </button>
    </div>
  </div>

  <div class="card shadow-sm p-3" style="box-shadow: black; border: none">
    <div class="card-body">
      <div class="mb-3 d-flex align-items-center justify-content-between">
        <!-- Search Field with FormGroup -->
        <form [formGroup]="searchForm">
          <input
            type="text"
            class="form-control"
            placeholder="Search"
            style="width: 280px"
            formControlName="searchTerm"
          />
        </form>

        <button
          class="btn"
          [disabled]="isAddingNewTopic"
          style="
            border-radius: 5px;
            border-color: #000000;
            width: 150px;
            justify-content: right;
          "
          (click)="addRow()"
        >
          Add Topic
        </button>
      </div>

      <div
        *ngIf="!topics.length"
        class="d-flex justify-content-start align-items-center"
        style="
          height: 40px;
          background-color: #f8fbff;
          border-radius: 5px;
          border: none;
        "
      >
        <span class="px-3 fw-semibold text-dark"
          >Please add a topic to see content</span
        >
      </div>

      <div class="table-responsive mt-2">
        <table class="table table-borderless table-responsive" style="width: 100%; table-layout:fixed;">
          <thead>
            <tr>
              <th style="background: #f8fbff; width: 3%;">Actions</th>
              <th style="background: #f8fbff; text-align: center; width: 2%;">
                <!-- <div class="d-flex flex-row align-items-center px-1"> -->
                  Order
                  <!-- <div
                    class="d-flex flex-column align-items-center ms-2"
                    style="font-size: x-small">
                    <i
                      class="fas fa-chevron-up"
                      (click)="sortTable('code', true)"
                      [style.color]="
                        sortedColumn === 'code' && isAscending
                          ? 'blue'
                          : 'black'
                      "
                    ></i>
                    <i
                      class="fas fa-chevron-down"
                      (click)="sortTable('code', false)"
                      [style.color]="
                        sortedColumn === 'code' && !isAscending
                          ? 'blue'
                          : 'black'
                      "
                    ></i>
                  </div> -->
                <!-- </div> -->
              </th>

              <th style="background: #f8fbff; text-align: center; width: 8%;">
                <div class="d-flex flex-row align-items-center">
                  Topic Name
                  <div
                    class="d-flex flex-column align-items-center ms-2"
                    style="font-size: x-small"
                  >
                    <i
                      class="fas fa-chevron-up"
                      (click)="sortTable('topicName', true)"
                      [style.color]="
                        sortedColumn === 'topicName' && isAscending
                          ? 'blue'
                          : 'black'
                      "
                    ></i>
                    <i
                      class="fas fa-chevron-down"
                      (click)="sortTable('topicName', false)"
                      [style.color]="
                        sortedColumn === 'topicName' && !isAscending
                          ? 'blue'
                          : 'black'
                      "
                    ></i>
                  </div>
                  <!-- <i class="fa-light fa-filter ms-3"></i> -->
                </div>
              </th>

              <th style="background: #f8fbff; width: 4%;">Theory Time</th>
              <th style="background: #f8fbff; width: 4%;">Practice Time</th>
              <th style="background: #f8fbff; width: 6%;">Summary</th>
              <th style="background: #f8fbff; width: 8%;">Content</th>
              <th style="background: #f8fbff; width: 5%;">Files</th>
            </tr>
          </thead>
          <tbody cdkDropList (cdkDropListDropped)="drop($event)">
            <tr
              *ngFor="
                let course of topics
                  | paginate
                    : { itemsPerPage: pageSize, currentPage: currentPage };
                let i = index"
                cdkDrag
            >
              <!-- Actions (Edit & Delete) -->
              <td
                [ngStyle]="{
                  background: i % 2 === 0 ? '#f8fbff' : 'transparent'
                }"
              >
              <button cdkDragHandle
              class="text-center cursor-grab"
              style="background-color: transparent; border: none"
              [disabled]="isAddingNewTopic || editingIndex !== null"
            >
            <i class="fas fa-bars"></i>
            </button>
                <button
                  (click)="editCourse(i + pageSize * (currentPage - 1))"
                  *ngIf="editingIndex !== i + pageSize * (currentPage - 1)"
                  style="background-color: transparent; border: none"
                  [disabled]="isAddingNewTopic"
                >
                  <i class="fa-regular fa-pencil"></i>
                </button>
                <button
                  (click)="deleteCourse(i + pageSize * (currentPage - 1))"
                  *ngIf="editingIndex !== i + pageSize * (currentPage - 1)"
                  style="background-color: transparent; border: none"
                >
                  <i class="fa-regular fa-trash"></i>
                </button>

                <!-- Save & Cancel Buttons in Edit Mode -->
                <button
                  (click)="saveCourse(i + pageSize * (currentPage - 1))"
                  (click)="closeDescriptionPopup()"
                  *ngIf="editingIndex === i + pageSize * (currentPage - 1)"
                  style="background-color: transparent; border: none"
                >
                  <i class="fa-regular fa-check"></i>
                </button>
                <button
                  (click)="cancelEdit()"
                  (click)="closeDescriptionPopup()"
                  *ngIf="editingIndex === i + pageSize * (currentPage - 1)"
                  style="background-color: transparent; border: none"
                >
                  <i class="fa-regular fa-xmark"></i>
                </button>
              </td>

              <!-- Order Column -->
              <td
                [ngStyle]="{
                  background: i % 2 === 0 ? '#f8fbff' : 'transparent'
                }"
                style="max-width: 100px"
                class="text-left px-3"
              >
              <span
                  *ngIf="editingIndex !== i + pageSize * (currentPage - 1)"
                  >{{ i+1 }}</span
                >



<!--
                <form
                  [formGroup]="topicForm"
                  *ngIf="editingIndex === i + pageSize * (currentPage - 1)"
                >
                  <input
                    type="text"
                    formControlName="code"
                    class="form-control"
                    style="height: 25px; font-size: inherit; border-radius: 0"
                    placeholder="Enter Code"
                  />
                </form> -->
              </td>

              <!-- Course Name -->
              <td
                [ngStyle]="{
                  background: i % 2 === 0 ? '#f8fbff' : 'transparent'
                }"
                style="max-width: 100px"
              >
                <span
                  *ngIf="editingIndex !== i + pageSize * (currentPage - 1)"
                  >{{ course.topicName }}</span
                >
                <form
                  [formGroup]="topicForm"
                  *ngIf="editingIndex === i + pageSize * (currentPage - 1)"
                >
                  <input
                    type="text"
                    formControlName="topicName"
                    class="form-control"
                    style="height: 25px; font-size: inherit; border-radius: 0"
                    placeholder="Enter Topic Name"
                  />
                </form>
              </td>

              <!-- Theory Time -->
              <td
                [ngStyle]="{
                  background: i % 2 === 0 ? '#f8fbff' : 'transparent'
                }"
                style="max-width: 50px"
              >
                <span
                  *ngIf="editingIndex !== i + pageSize * (currentPage - 1)"
                  >{{ course.theoryTime }}</span
                >
                <form
                  [formGroup]="topicForm"
                  *ngIf="editingIndex === i + pageSize * (currentPage - 1)"
                >
                  <input
                    type="text"
                    formControlName="theoryTime"
                    class="form-control"
                    style="height: 25px; font-size: inherit; border-radius: 0"
                    placeholder="0 hr"
                  />
                </form>
              </td>

              <!-- Practice Time -->
              <td
                [ngStyle]="{
                  background: i % 2 === 0 ? '#f8fbff' : 'transparent'
                }"
                style="max-width: 40px"
              >
                <span
                  *ngIf="editingIndex !== i + pageSize * (currentPage - 1)"
                  >{{ course.practiceTime }}</span
                >
                <form
                  [formGroup]="topicForm"
                  *ngIf="editingIndex === i + pageSize * (currentPage - 1)"
                >
                  <input
                    type="text"
                    formControlName="practiceTime"
                    class="form-control"
                    style="height: 25px; font-size: inherit; border-radius: 0"
                    placeholder="0 hr"
                  />
                </form>
              </td>

              <!-- Description -->
              <td
  [ngStyle]="{
    background: i % 2 === 0 ? '#f8fbff' : 'transparent'
  }"
  style="
    width: 20%; /* Adjust this based on total number of columns */
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
    color: #2f72f4;
    text-decoration: underline;
    cursor: pointer;
  "
>
  <app-custom-tooltip
    [text]="course.summary"
    [position]="'top'"
  >
    <!-- VIEW MODE -->
    <span
      *ngIf="editingIndex !== i + pageSize * (currentPage - 1)"
      style="
        display: inline-block;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      "
    >
      {{ course.summary }}
    </span>
  </app-custom-tooltip>

  <!-- EDIT MODE -->
  <span
    *ngIf="editingIndex === i + pageSize * (currentPage - 1)"
    (click)="openDescriptionPopup($event, course)"
    style="
      font-size: small;
      text-align: left;
      display: inline-block;
      width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #2f72f4;
      text-decoration: underline;
      cursor: pointer;
    "
  >
    {{
      topicForm.get('summary')?.value.length === 0
        ? 'Add Description'
        : topicForm.get('summary')?.value
    }}
  </span>
</td>



              <!-- Topics Column with Tooltip -->
              <td
              [ngStyle]="{
                background: i % 2 === 0 ? '#f8fbff' : 'transparent'
              }"
              style="
                width: 20%; /* Adjust this based on total number of columns */
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                color: #2f72f4;
                text-decoration: underline;
                cursor: pointer;
              "
            >
              <app-custom-tooltip
                [text]="course.content"
                [position]="'top'"
              >
                <!-- VIEW MODE -->
                <span
                  *ngIf="editingIndex !== i + pageSize * (currentPage - 1)"
                  style="
                    display: inline-block;
                    width: 100%;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                  "
                >
                  {{ course.content }}
                </span>
              </app-custom-tooltip>

              <!-- EDIT MODE -->
              <span
                *ngIf="editingIndex === i + pageSize * (currentPage - 1)"
                (click)="openDescriptionPopup($event, course)"
                style="
                  font-size: small;
                  text-align: left;
                  display: inline-block;
                  width: 100%;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                  color: #2f72f4;
                  text-decoration: underline;
                  cursor: pointer;
                "
              >
                {{
                  topicForm.get('content')?.value.length === 0
                    ? 'Add Description'
                    : topicForm.get('content')?.value
                }}
              </span>
            </td>
            <td>
                 <button
                  (click)="editCourse(i + pageSize * (currentPage - 1))"
                  *ngIf="editingIndex !== i + pageSize * (currentPage - 1)"
                  style="background-color: transparent; border: none"
                  [disabled]="isAddingNewTopic"
                >
                <i class="fas fa-arrow-up-from-bracket"></i>
                </button>


            </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div
        class="d-flex justify-content-end align-items-center w-100 custom-font"
      >
        <span class="me-3">
          Showing {{ (currentPage - 1) * pageSize + 1 }} to
          {{
            currentPage * pageSize > topics.length
              ? topics.length
              : currentPage * pageSize
          }}
          of {{ topics.length }} entries
        </span>

        <pagination-controls
          (pageChange)="currentPage = $event"
          class="align-items-center mt-3"
        ></pagination-controls>

        <form [formGroup]="pageSizeForm" class="d-flex align-items-center ms-2">
          <input
            type="number"
            class="form-control"
            style="width: 60px; height: 23px"
            formControlName="pageSize"
            min="1"
            [max]="topics.length"
          />
        </form>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>

<!-- Description Modal -->
<div
  class="description-popup shadow-sm p-3"
  *ngIf="isSummaryPopupOpen"
  [style.top.px]="popupPosition.top"
  [style.left.px]="popupPosition.left"
>
  <div class="d-flex justify-content-between align-items-center">
    <h6 class="mb-2">Summary</h6>
    <button class="btn-close" (click)="closeDescriptionPopup()"></button>
  </div>
  <form [formGroup]="summaryForm">
    <textarea
      class="form-control"
      rows="3"
      formControlName="description"
      maxlength="40"
    ></textarea>
    <div
      *ngIf="
        summaryForm.get('description')?.invalid &&
        summaryForm.get('description')?.touched
      "
      class="text-danger small"
    >
      <div *ngIf="summaryForm.get('description')?.errors?.['required']">
        Description is required.
      </div>
      <div *ngIf="summaryForm.get('description')?.errors?.['maxlength']">
        Description cannot exceed 40 characters.
      </div>
    </div>
  </form>
  <div class="d-flex justify-content-between align-items-center mt-3">
    <small class="text-muted"
      >{{ summaryForm.get("summary")?.value.length }}/40</small
    >
    <div>
      <button
        class="btn btn-primary me-2"
        style="min-width: 100px"
        (click)="saveDescription(); closeDescriptionPopup()"
        [disabled]="summaryForm.invalid"
      >
        Save
      </button>
      <button
        class="btn btn-outline-secondary"
        style="min-width: 100px"
        (click)="closeDescriptionPopup()"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
<!-- Delete Confirmation Modal -->
<div
  class="modal fade"
  id="deleteConfirmationModal"
  tabindex="-1"
  aria-labelledby="deleteConfirmationModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div
        class="modal-header flex-column align-items-start pb-0"
        style="border-bottom: none"
      >
        <h5 class="modal-title" id="deleteConfirmationModalLabel">
          Delete Course
        </h5>
        <hr class="modal-title-line w-100 m-0 mt-3" />
        <button
          type="button"
          class="btn-close position-absolute end-0 top-0 m-3"
          data-bs-dismiss="modal"
          aria-label="Close"
        >
          <i class="fa-solid fa-xmark-large"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure that you want to delete course
          <span id="courseCodeToDelete"></span>?
        </p>
      </div>
      <div class="modal-footer justify-content-end border-0 pt-0">
        <button
          type="button"
          class="btn btn-primary px-4"
          id="confirmDeleteBtn"
          style="
            background-color: #2962ff;
            border-radius: 6px;
            font-weight: 500;
          "
        >
          Yes
        </button>
        <button
          type="button"
          class="btn btn-outline-secondary px-4 ms-2"
          data-bs-dismiss="modal"
          style="border-radius: 6px; font-weight: 500"
        >
          No
        </button>
      </div>
    </div>
  </div>
</div>
